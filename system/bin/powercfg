#!/system/bin/sh
# Project WIPE v2 https://github.com/yc9559/wipe-v2
# Author: yc9559
# Platform: e8895
# Generated at: 2019-05-25 15:24:06

CUR_LEVEL_FILE="/dev/.wipe_cur_level"
PARAM_BAK_FILE="/dev/.wipe_param_bak"

# const variables
PARAM_NUM=35

# sysfs_objx example:
# sysfs_obj1="${C0_GOVERNOR_DIR}/target_loads"
SCHED_DIR="/proc/sys/kernel/hmp"
C0_GOVERNOR_DIR="/sys/devices/system/cpu/cpu0/cpufreq/interactive"
C1_GOVERNOR_DIR="/sys/devices/system/cpu/cpu4/cpufreq/interactive"
C0_DIR="/sys/devices/system/cpu/cpu0"
C1_DIR="/sys/devices/system/cpu/cpu4"

sysfs_obj1="/sys/power/cpuhotplug/enabled"
sysfs_obj2="/sys/devices/system/cpu/cpuhotplug/enabled"
sysfs_obj3="${C0_DIR}/online"
sysfs_obj4="${C0_DIR}/cpufreq/scaling_governor"
sysfs_obj5="${C0_DIR}/cpufreq/scaling_min_freq"
sysfs_obj6="${C0_DIR}/cpufreq/scaling_max_freq"
sysfs_obj7="${C0_GOVERNOR_DIR}/hispeed_freq"
sysfs_obj8="${C0_GOVERNOR_DIR}/go_hispeed_load"
sysfs_obj9="${C0_GOVERNOR_DIR}/min_sample_time"
sysfs_obj10="${C0_GOVERNOR_DIR}/max_freq_hysteresis"
sysfs_obj11="${C0_GOVERNOR_DIR}/above_hispeed_delay"
sysfs_obj12="${C0_GOVERNOR_DIR}/target_loads"
sysfs_obj13="${C0_GOVERNOR_DIR}/timer_rate"
sysfs_obj14="${C0_GOVERNOR_DIR}/timer_slack"
sysfs_obj15="${C0_GOVERNOR_DIR}/boost"
sysfs_obj16="${C0_GOVERNOR_DIR}/boostpulse_duration"
sysfs_obj17="${C1_DIR}/online"
sysfs_obj18="${C1_DIR}/cpufreq/scaling_governor"
sysfs_obj19="${C1_DIR}/cpufreq/scaling_min_freq"
sysfs_obj20="${C1_DIR}/cpufreq/scaling_max_freq"
sysfs_obj21="${C1_GOVERNOR_DIR}/hispeed_freq"
sysfs_obj22="${C1_GOVERNOR_DIR}/go_hispeed_load"
sysfs_obj23="${C1_GOVERNOR_DIR}/min_sample_time"
sysfs_obj24="${C1_GOVERNOR_DIR}/max_freq_hysteresis"
sysfs_obj25="${C1_GOVERNOR_DIR}/above_hispeed_delay"
sysfs_obj26="${C1_GOVERNOR_DIR}/target_loads"
sysfs_obj27="${C1_GOVERNOR_DIR}/timer_rate"
sysfs_obj28="${C1_GOVERNOR_DIR}/timer_slack"
sysfs_obj29="${C1_GOVERNOR_DIR}/boost"
sysfs_obj30="${C1_GOVERNOR_DIR}/boostpulse_duration"
sysfs_obj31="${SCHED_DIR}/down_threshold"
sysfs_obj32="${SCHED_DIR}/up_threshold"
sysfs_obj33="${SCHED_DIR}/down_threshold"
sysfs_obj34="${SCHED_DIR}/load_avg_period_ms"
sysfs_obj35="${SCHED_DIR}/boost"


# level x example:
# lag percent: 90.0%
# battery life: 110.0%
# levelx_val1="38000"
# levelx_val2="85 1190000:90"

# LEVEL 0
# lag percent: 65.8%
# battery life: 115.8%
level0_val1="0"
level0_val2="0"
level0_val3="1"
level0_val4="interactive"
level0_val5="454000"
level0_val6="1691000"
level0_val7="1456000"
level0_val8="90"
level0_val9="18000"
level0_val10="38000"
level0_val11="98000"
level0_val12="56 598000:32 715000:74 832000:36 949000:37 1053000:15 1248000:32 1456000:46 1690000:54"
level0_val13="20000"
level0_val14="12345678"
level0_val15="0"
level0_val16="0"
level0_val17="1"
level0_val18="interactive"
level0_val19="740000"
level0_val20="2315000"
level0_val21="1937000"
level0_val22="98"
level0_val23="18000"
level0_val24="38000"
level0_val25="198000"
level0_val26="70 858000:35 962000:77 1066000:51 1170000:82 1261000:89 1469000:95 1703000:77 1807000:72 1937000:99 2002000:98 2158000:99"
level0_val27="20000"
level0_val28="12345678"
level0_val29="0"
level0_val30="0"
level0_val31="238"
level0_val32="983"
level0_val33="238"
level0_val34="128"
level0_val35="0"

# LEVEL 1
# lag percent: 14.9%
# battery life: 96.8%
level1_val1="0"
level1_val2="0"
level1_val3="1"
level1_val4="interactive"
level1_val5="454000"
level1_val6="1691000"
level1_val7="1456000"
level1_val8="98"
level1_val9="18000"
level1_val10="18000"
level1_val11="78000"
level1_val12="75 598000:56 715000:71 832000:68 949000:76 1053000:71 1248000:86 1456000:64 1690000:65"
level1_val13="20000"
level1_val14="12345678"
level1_val15="0"
level1_val16="0"
level1_val17="1"
level1_val18="interactive"
level1_val19="740000"
level1_val20="2315000"
level1_val21="1937000"
level1_val22="73"
level1_val23="18000"
level1_val24="18000"
level1_val25="198000"
level1_val26="67 858000:49 962000:42 1066000:63 1170000:88 1261000:86 1469000:71 1703000:89 1807000:63 1937000:98 2002000:99 2314000:95"
level1_val27="20000"
level1_val28="12345678"
level1_val29="0"
level1_val30="0"
level1_val31="162"
level1_val32="762"
level1_val33="162"
level1_val34="128"
level1_val35="0"

# LEVEL 2
# lag percent: 29.8%
# battery life: 104.1%
level2_val1="0"
level2_val2="0"
level2_val3="1"
level2_val4="interactive"
level2_val5="454000"
level2_val6="1691000"
level2_val7="1456000"
level2_val8="91"
level2_val9="18000"
level2_val10="18000"
level2_val11="118000"
level2_val12="56 598000:57 715000:24 832000:29 949000:57 1053000:60 1248000:41 1456000:48 1690000:73"
level2_val13="20000"
level2_val14="12345678"
level2_val15="0"
level2_val16="0"
level2_val17="1"
level2_val18="interactive"
level2_val19="740000"
level2_val20="2315000"
level2_val21="1937000"
level2_val22="98"
level2_val23="18000"
level2_val24="38000"
level2_val25="198000"
level2_val26="70 858000:77 962000:59 1066000:5 1170000:82 1261000:89 1469000:95 1703000:75 1807000:71 1937000:99 2002000:98 2158000:99 2314000:95"
level2_val27="20000"
level2_val28="12345678"
level2_val29="0"
level2_val30="0"
level2_val31="162"
level2_val32="798"
level2_val33="162"
level2_val34="128"
level2_val35="0"

# LEVEL 3
# lag percent: 50.0%
# battery life: 110.8%
level3_val1="0"
level3_val2="0"
level3_val3="1"
level3_val4="interactive"
level3_val5="454000"
level3_val6="1691000"
level3_val7="1456000"
level3_val8="95"
level3_val9="18000"
level3_val10="58000"
level3_val11="58000"
level3_val12="36 598000:13 715000:35 832000:44 949000:30 1053000:44 1248000:22 1456000:66 1690000:78"
level3_val13="20000"
level3_val14="12345678"
level3_val15="0"
level3_val16="0"
level3_val17="1"
level3_val18="interactive"
level3_val19="740000"
level3_val20="2315000"
level3_val21="1937000"
level3_val22="94"
level3_val23="18000"
level3_val24="38000"
level3_val25="198000"
level3_val26="70 858000:32 962000:69 1066000:55 1170000:82 1261000:90 1469000:96 1703000:78 1807000:69 1937000:99 2314000:98"
level3_val27="20000"
level3_val28="12345678"
level3_val29="0"
level3_val30="0"
level3_val31="223"
level3_val32="954"
level3_val33="223"
level3_val34="128"
level3_val35="0"

# LEVEL 4
# lag percent: 75.0%
# battery life: 118.7%
level4_val1="0"
level4_val2="0"
level4_val3="1"
level4_val4="interactive"
level4_val5="454000"
level4_val6="1691000"
level4_val7="1456000"
level4_val8="91"
level4_val9="18000"
level4_val10="58000"
level4_val11="98000"
level4_val12="52 598000:40 715000:39 832000:61 949000:7 1053000:43 1248000:18 1456000:49 1690000:29"
level4_val13="20000"
level4_val14="12345678"
level4_val15="0"
level4_val16="0"
level4_val17="1"
level4_val18="interactive"
level4_val19="740000"
level4_val20="2315000"
level4_val21="1937000"
level4_val22="98"
level4_val23="18000"
level4_val24="18000"
level4_val25="198000"
level4_val26="70 858000:40 962000:79 1066000:31 1170000:82 1261000:91 1469000:97 1703000:80 1807000:78 1937000:99 2314000:95"
level4_val27="20000"
level4_val28="12345678"
level4_val29="0"
level4_val30="0"
level4_val31="235"
level4_val32="996"
level4_val33="235"
level4_val34="128"
level4_val35="0"

# LEVEL 5
# lag percent: 99.0%
# battery life: 125.4%
level5_val1="0"
level5_val2="0"
level5_val3="1"
level5_val4="interactive"
level5_val5="454000"
level5_val6="1691000"
level5_val7="1456000"
level5_val8="87"
level5_val9="18000"
level5_val10="58000"
level5_val11="58000"
level5_val12="53 598000:19 715000:34 832000:45 949000:39 1053000:24 1248000:28 1456000:65"
level5_val13="20000"
level5_val14="12345678"
level5_val15="0"
level5_val16="0"
level5_val17="1"
level5_val18="interactive"
level5_val19="740000"
level5_val20="2315000"
level5_val21="1937000"
level5_val22="96"
level5_val23="18000"
level5_val24="18000"
level5_val25="198000"
level5_val26="67 858000:46 962000:29 1066000:9 1170000:82 1261000:90 1469000:95 1703000:82 1807000:68 1937000:99 2314000:97"
level5_val27="20000"
level5_val28="12345678"
level5_val29="0"
level5_val30="0"
level5_val31="537"
level5_val32="961"
level5_val33="537"
level5_val34="128"
level5_val35="1"

# LEVEL 6
# lag percent: 119.9%
# battery life: 130.3%
level6_val1="0"
level6_val2="0"
level6_val3="1"
level6_val4="interactive"
level6_val5="454000"
level6_val6="1691000"
level6_val7="1456000"
level6_val8="89"
level6_val9="18000"
level6_val10="138000"
level6_val11="158000"
level6_val12="40 598000:36 715000:48 832000:38 949000:44 1053000:38 1248000:21 1456000:64 1690000:82"
level6_val13="20000"
level6_val14="12345678"
level6_val15="0"
level6_val16="0"
level6_val17="1"
level6_val18="interactive"
level6_val19="740000"
level6_val20="2315000"
level6_val21="1937000"
level6_val22="99"
level6_val23="18000"
level6_val24="18000"
level6_val25="198000"
level6_val26="60 858000:42 962000:73 1066000:45 1170000:82 1261000:88 1469000:95 1703000:82 1807000:74 1937000:99 2002000:98 2158000:99 2314000:94"
level6_val27="20000"
level6_val28="12345678"
level6_val29="0"
level6_val30="0"
level6_val31="627"
level6_val32="968"
level6_val33="627"
level6_val34="128"
level6_val35="0"


# global variables
HAS_BAK=0
NOT_MATCH_NUM=0

# $1:value $2:file path
lock_value() 
{
	if [ -f ${2} ]; then
		chmod 0666 ${2}
		echo ${1} > ${2}
		chmod 0444 ${2}
	fi
}

# $1:level_number
apply_level() 
{
	# 0. SELinux permissive
	setenforce 0
    # 1. backup
    backup_default
    # 2. apply modification
    for n in `seq ${PARAM_NUM}`
    do
        eval obj="$"sysfs_obj${n}
        eval val="$"level${1}_val${n}
        lock_value "${val}" ${obj}
    done
    # 3. save current level to file
    echo ${1} > ${CUR_LEVEL_FILE}
}

# $1:value $2:file path
check_value() 
{
    if [ -f ${2} ]; then
        expected="${1}"
        actual="`cat ${2}`"
        if [ "${actual}" != "${expected}" ]; then
            # input_boost_freq has a additional line break
            case1=$(echo "${actual}" | grep "${expected}")
            # Actual scaling_min_freq is 633600, but given is 633000. That's OK
            case2=$(echo "${2}" | grep -E "scaling_m.{2}_freq$")
            # skip msm_performance/parameters: cpu_min_freq and cpu_max_freq
            case3=$(echo "${2}" | grep -E "cpu_m.{2}_freq$")
            if [ "${case1}" == "" ] && [ "${case2}" == "" ] && [ "${case3}" == "" ]; then
                NOT_MATCH_NUM=$(expr ${NOT_MATCH_NUM} + 1)
                echo "[FAIL] ${2}"
                echo "expected: ${expected}"
                echo "actual: ${actual}"
            fi
        fi
    else
        echo "[IGNORE] ${2}"
    fi
}

# $1:level_number
verify_level() 
{
    for n in `seq ${PARAM_NUM}`
    do
        eval obj="$"sysfs_obj${n}
        eval val="$"level${1}_val${n}
        check_value "${val}" ${obj}
    done
    echo "Verified ${PARAM_NUM} parameters, ${NOT_MATCH_NUM} FAIL"
}

backup_default()
{
    if [ ${HAS_BAK} -eq 0 ]; then
        # clear previous backup file
        echo "" > ${PARAM_BAK_FILE}
        for n in `seq ${PARAM_NUM}`
        do
            eval obj="$"sysfs_obj${n}
            echo "bak_obj${n}=${obj}" >> ${PARAM_BAK_FILE}
            echo "bak_val${n}=\"`cat ${obj}`\"" >> ${PARAM_BAK_FILE}
        done
        echo "Backup default parameters has completed."
    else
        echo "Backup file already exists, skip backup."
    fi
}

restore_default()
{
    if [ -f ${PARAM_BAK_FILE} ]; then
        # read backup variables
        while read line
        do
            eval ${line}
        done < ${PARAM_BAK_FILE}
        # set backup variables
        for n in `seq ${PARAM_NUM}`
        do
            eval obj="$"bak_obj${n}
            eval val="$"bak_val${n}
            lock_value "${val}" ${obj}
        done
        echo "Restore OK"
    else
        echo "Backup file for default parameters not found."
        echo "Restore FAIL"
    fi
}

permanently_disable_perfd()
{
    stop perfd
    perfd_path=`which perfd`
    if [ -n "${perfd_path}" ]; then
        mv ${perfd_path} `dirname ${perfd_path}`/perfd_bak
        echo "Perfd has been disabled."
    else
        echo "Perfd binary not found."
    fi
}

permanently_enable_perfd()
{
    perfd_bak_path=`which perfd_bak`
    if [ -n "${perfd_bak_path}" ]; then
        mv ${perfd_bak_path} `dirname ${perfd_bak_path}`/perfd
        echo "Perfd has been enabled."
    else
        echo "Perfd_bak binary not found."
    fi
    start perfd
}

# suppress stderr
(

echo ""

# backup runonce flag
if [ -f ${PARAM_BAK_FILE} ]; then
    HAS_BAK=1
fi

action=$1
# default option is balance
if [ ! -n "$action" ]; then
    action="balance"
fi

if [ "$action" = "debug" ]; then
	echo "Project WIPE v2 https://github.com/yc9559/wipe-v2"
	echo "Author: yc9559"
	echo "Platform: e8895"
	echo "Generated at: 2019-05-25 15:24:06"
	echo ""
    # perform parameter verification
    cur_level=`cat ${CUR_LEVEL_FILE}`
	if [ -n "${cur_level}" ]; then
        echo "Current level: ${cur_level}"
        verify_level ${cur_level}
    else
        echo "Current level: not detected"
    fi
    echo ""
	exit 0
fi

if [ "$action" = "restore" ]; then
	restore_default
    rm ${CUR_LEVEL_FILE}
fi

if [ "$action" = "powersave" ]; then
    echo "Applying powersave..."
    apply_level 5
    echo "Applying powersave done."
fi

if [ "$action" = "balance" ]; then
    echo "Applying balance..."
    apply_level 3
    echo "Applying balance done."
fi

if [ "$action" = "performance" ]; then
    echo "Applying performance..."
    apply_level 1
    echo "Applying performance done."
fi

if [ "$action" = "fast" ]; then
    echo "Applying fast..."
    apply_level 0
    echo "Applying fast done."
fi

if [ "$action" = "level" ]; then
    level=${2}
    if [ "${level}" -ge "0" ] && [ "${level}" -le "6" ]; then
        echo "Applying level ${level}..."
        apply_level ${level}
        echo "Applying level ${level} done."
    else
        echo "Level ${level} not supported."
    fi
fi

if [ "$action" = "perfd" ]; then
    cmd=${2}
    if [ "${cmd}" == "enable" ]; then
        permanently_enable_perfd
    fi
    if [ "${cmd}" == "disable" ]; then
        permanently_disable_perfd
    fi
fi

echo ""

# suppress stderr
) 2>/dev/null

exit 0
